- name: Check if OS is Ubuntu LTS "
  fail: msg="Server must be Ubuntu LTS"
  when: ansible_distribution != 'Ubuntu'
    or (ansible_distribution_version != '14.04'
      and ansible_distribution_version != '16.04'
      and ansible_distribution_version != '18.04')

- name: Add NGINX PPA so we can get a more recent version than with stock apt
  apt_repository:
    repo: ppa:nginx/stable
    state: present

- name: Install NGINX
  apt:
    name: nginx
    update_cache: yes
    state: present

- name: Ensure nginx is started.
  service:
    name: nginx
    state: started

- name: Increase value of server_names_hash_bucket_size
  replace:
    dest: /etc/nginx/nginx.conf
    regexp: '# server_names_hash_bucket_size \d+'
    replace: 'server_names_hash_bucket_size 128'
    # validate='/usr/sbin/nginx -tt'
  notify:
    - reload nginx

- name: Hide NGINX version
  copy:
    dest: /etc/nginx/conf.d/hide-nginx-version.conf
    content: >
      server_tokens off;
    force: true
    backup: true
    mode: 0644
    owner: root
    group: root
  notify:
    - reload nginx

- name: Provide alternate nginx log format for use when running behind a load balancer
  copy:
    src: {{ role_path }}/files/etc/nginx/conf.d/log_format_proxied.conf
    dest: /etc/nginx/conf.d/log_format_proxied.conf
  notify: reload nginx
  tags:
    - nginx
